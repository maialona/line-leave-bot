<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>204åºœåŸå¤§å¸« (Preview)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(90deg, #4F46E5 0%, #7C3AED 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
    <!-- Mock LIFF for local preview -->
    <script>
        const liff = {
            init: async () => { console.log('Mock LIFF Init'); return Promise.resolve(); },
            isLoggedIn: () => true, // FIXED: Simulate logged in so it proceeds
            login: () => console.log('Mock Login'),
            getProfile: () => Promise.resolve({ userId: 'mock-user', displayName: 'Test User' }),
            closeWindow: () => console.log('Mock Close Window')
        };
    </script>
</head>

<body class="text-gray-800 antialiased p-4 flex justify-center items-start pt-10">
    <div id="app" class="w-full max-w-md relative">
        <!-- Loading State -->
        <div v-if="loading"
            class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-white/50 backdrop-blur-sm rounded-2xl h-96">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            <p class="mt-4 text-indigo-800 font-medium">è¼‰å…¥ä¸­...</p>
        </div>

        <!-- Main Content -->
        <transition name="fade">
            <div v-if="!loading" class="glass-card p-6 w-full min-h-[500px] flex flex-col">

                <!-- 0. Landing Page -->
                <div v-if="currentView === 'landing'"
                    class="flex-1 flex flex-col items-center justify-center text-center space-y-8 py-8">
                    <div class="space-y-4">
                        <div
                            class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto shadow-inner">
                            <span class="text-4xl">ğŸŒŸ</span>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800 tracking-tight">204åºœåŸå¤§å¸«</h1>
                        <p class="text-gray-500 text-lg">æ­¡è¿ä½¿ç”¨å“¡å·¥è‡ªåŠ©æœå‹™ç³»çµ±</p>
                    </div>

                    <button @click="currentView = 'menu'"
                        class="w-full max-w-xs btn-primary text-white font-bold text-lg py-4 px-8 rounded-2xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition duration-300">
                        é–‹å§‹ä½¿ç”¨
                    </button>

                    <p class="text-xs text-gray-400 absolute bottom-6">v1.2.0 â€¢ Build for Efficiency</p>
                </div>

                <!-- 0. Main Menu -->
                <div v-else-if="currentView === 'menu'" class="flex-1 flex flex-col">
                    <div class="text-center mb-8">
                        <h2 class="text-xl font-bold text-gray-800">è«‹é¸æ“‡æœå‹™</h2>
                        <p class="text-sm text-gray-500 mt-1">æ‚¨ä»Šå¤©éœ€è¦ä»€éº¼å”åŠ©ï¼Ÿ</p>
                    </div>

                    <div class="space-y-4 flex-1">
                        <!-- Button 1: Bulletin -->
                        <div @click="currentView = 'bulletin'"
                            class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer flex items-center space-x-4 group">
                            <div
                                class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                                ğŸ“¢</div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800">ä½ˆå‘Šæ¬„</h3>
                                <p class="text-xs text-gray-500">æŸ¥çœ‹æœ€æ–°å…¬å‘Šèˆ‡é€šçŸ¥</p>
                            </div>
                            <div class="ml-auto text-gray-300 group-hover:text-blue-500">â†’</div>
                        </div>

                        <!-- Button 2: Leave Application -->
                        <div @click="currentView = 'leave'"
                            class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer flex items-center space-x-4 group">
                            <div
                                class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                                ğŸ“</div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800">è«‹å‡ç”³è«‹</h3>
                                <p class="text-xs text-gray-500">ç”³è«‹ä¼‘å‡ã€ç—…å‡æˆ–è£œä¼‘</p>
                            </div>
                            <div class="ml-auto text-gray-300 group-hover:text-indigo-500">â†’</div>
                        </div>

                        <!-- Button 3: Case/Dev Apply -->
                        <div @click="currentView = 'dev_apply'"
                            class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition cursor-pointer flex items-center space-x-4 group">
                            <div
                                class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-2xl group-hover:scale-110 transition">
                                ğŸ’¼</div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-800">é–‹æ¡ˆï¼é–‹ç™¼ç”³è«‹</h3>
                                <p class="text-xs text-gray-500">æ–°æ¡ˆä»¶èˆ‡æ¥­å‹™é–‹ç™¼ç”³è«‹</p>
                            </div>
                            <div class="ml-auto text-gray-300 group-hover:text-green-500">â†’</div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder: Bulletin -->
                <div v-else-if="currentView === 'bulletin'"
                    class="flex-1 flex flex-col text-center justify-center space-y-4">
                    <div class="text-6xl">ğŸš§</div>
                    <h3 class="text-xl font-bold text-gray-800">åŠŸèƒ½é–‹ç™¼ä¸­</h3>
                    <p class="text-gray-500">ä½ˆå‘Šæ¬„åŠŸèƒ½å³å°‡ä¸Šç·šï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                    <button @click="currentView = 'menu'" class="mt-8 text-indigo-600 font-medium hover:underline">â†
                        è¿”å›ä¸»é¸å–®</button>
                </div>

                <!-- Placeholder: Dev Apply -->
                <div v-else-if="currentView === 'dev_apply'"
                    class="flex-1 flex flex-col text-center justify-center space-y-4">
                    <div class="text-6xl">ğŸš§</div>
                    <h3 class="text-xl font-bold text-gray-800">åŠŸèƒ½é–‹ç™¼ä¸­</h3>
                    <p class="text-gray-500">é–‹æ¡ˆç”³è«‹åŠŸèƒ½å³å°‡ä¸Šç·šï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                    <button @click="currentView = 'menu'" class="mt-8 text-indigo-600 font-medium hover:underline">â†
                        è¿”å›ä¸»é¸å–®</button>
                </div>

                <!-- Existing Leave App Logic -->
                <div v-else-if="currentView === 'leave'">
                    <!-- Header with Back Button -->
                    <div class="mb-6 relative text-center">
                        <button @click="currentView = 'menu'"
                            class="absolute left-0 top-1 text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-900">è«‹å‡ç”³è«‹</h1>
                        <p class="text-sm text-gray-500 mt-1">204åºœåŸå¤§å¸«</p>
                    </div>

                    <!-- 1. Registration View (Unbound) -->
                    <div v-if="!user.registered">
                        <div class="space-y-4">
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                                <p class="text-sm text-yellow-700">æ‚¨å°šæœªç¶å®šå“¡å·¥è³‡æ–™ï¼Œè«‹å…ˆå®Œæˆé©—è­‰ã€‚</p>
                                <p class="text-xs text-yellow-600 mt-1">è‹¥æ‚¨æœ‰å¤šå€‹æœå‹™å–®ä½ï¼Œå¯åœ¨æ­¤ç¶å®šç¬¬äºŒå€‹å–®ä½çš„è³‡æ–™ã€‚</p>
                            </div>

                            <!-- Unit Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡å–®ä½</label>
                                <select v-model="regForm.unit"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border">
                                    <option disabled value="">è«‹é¸æ“‡</option>
                                    <option v-for="u in units" :key="u" :value="u">{{ u }}</option>
                                </select>
                            </div>

                            <!-- Name Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ‚¨çš„å§“å</label>
                                <input type="text" v-model="regForm.name"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border"
                                    placeholder="è«‹è¼¸å…¥å§“å">
                            </div>

                            <!-- Staff ID Verification -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å“¡å·¥ç·¨è™Ÿ (Staff ID)</label>
                                <input type="text" v-model="regForm.staffId"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border"
                                    placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ">
                            </div>

                            <button @click="bindUser" :disabled="submitting"
                                class="w-full btn-primary text-white font-bold py-3 px-4 rounded-xl shadow-lg mt-4 disabled:opacity-50">
                                {{ submitting ? 'é©—è­‰ä¸­...' : 'ç¢ºèªç¶å®š' }}
                            </button>
                        </div>
                    </div>

                    <!-- 2. Supervisor Dashboard -->
                    <div v-else-if="['Supervisor', 'ç£å°'].includes(user.role)">
                        <div class="mb-4 flex items-center justify-between bg-purple-50 p-3 rounded-lg">
                            <div>
                                <span class="text-purple-900 font-medium block">ğŸ‘‹ æ‚¨å¥½ï¼Œ{{ user.name }}</span>
                                <div @click="showProfileSelector = true"
                                    class="flex items-center space-x-1 cursor-pointer mt-1">
                                    <span class="text-xs text-purple-600 underline">
                                        {{ user.profiles && user.profiles.length > 1 ? 'åˆ‡æ›èº«ä»½ (' + user.profiles.length +
                                        ')' : '+ ç¶å®šæ–°å–®ä½' }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                <span
                                    class="text-xs bg-white text-purple-600 border border-purple-200 px-2 py-1 rounded-full">{{
                                    user.unit }}</span>
                                <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">ç£å°</span>
                            </div>
                        </div>

                        <!-- Leaderboard Widget -->
                        <div class="mb-6 bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                            <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                                ğŸ† æœ¬æœˆè«‹å‡æ’è¡Œæ¦œ (å‰äº”å)
                            </h3>
                            <div v-if="monthlyStats.length === 0" class="text-xs text-gray-400 text-center py-2">
                                æœ¬æœˆå°šç„¡æ ¸å‡†çš„è«‹å‡ç´€éŒ„
                            </div>
                            <div v-else class="space-y-3">
                                <div v-for="(stat, idx) in monthlyStats" :key="stat.name" class="relative">
                                    <div class="flex justify-between text-xs mb-1">
                                        <span class="font-medium text-gray-700">
                                            <span class="inline-block w-4 text-center mr-1"
                                                :class="{'text-yellow-500 font-bold': idx < 3, 'text-gray-400': idx >= 3}">{{
                                                idx + 1 }}</span>
                                            {{ stat.name }}
                                        </span>
                                        <span class="text-indigo-600 font-bold">{{ stat.days }} å¤©</span>
                                    </div>
                                    <div class="w-full bg-gray-100 rounded-full h-2">
                                        <div class="bg-indigo-500 h-2 rounded-full transition-all duration-500"
                                            :style="{ width: (stat.days / maxDays * 100) + '%' }"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="flex space-x-2 mb-4 border-b border-gray-200">
                            <button @click="activeTab = 'pending'"
                                :class="activeTab === 'pending' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="flex-1 py-2 px-1 text-center border-b-2 font-medium text-sm">
                                å¾…å¯©æ ¸
                                <span v-if="pendingLeaves.length > 0"
                                    class="ml-1 bg-red-100 text-red-600 py-0.5 px-2 rounded-full text-xs">{{
                                    pendingLeaves.length }}</span>
                            </button>
                            <button @click="activeTab = 'history'"
                                :class="activeTab === 'history' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="flex-1 py-2 px-1 text-center border-b-2 font-medium text-sm">
                                å…¨éƒ¨ç´€éŒ„
                            </button>
                        </div>

                        <!-- Tab: Pending -->
                        <div v-if="activeTab === 'pending'" class="space-y-4">
                            <div v-if="pendingLeaves.length === 0" class="text-center py-8 text-gray-400">
                                <p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å‡å–® ğŸ‰</p>
                            </div>
                            <div v-for="leave in pendingLeaves" :key="leave.id"
                                class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="font-bold text-gray-900">{{ leave.name }}</h3>
                                        <span class="text-xs text-gray-500">{{ leave.timestamp.split('T')[0] }}
                                            ç”³è«‹</span>
                                    </div>
                                    <span
                                        class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">{{
                                        leave.leaveType }}</span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1 mb-3">
                                    <p>ğŸ“… æ—¥æœŸ: <span class="font-medium text-gray-800">{{ leave.date }}</span></p>
                                    <p>ğŸ“ åŸå› : {{ leave.reason }}</p>

                                    <!-- Case List -->
                                    <div v-if="leave.cases && leave.cases.length > 0"
                                        class="mt-2 bg-gray-50 p-2 rounded-lg border border-gray-100">
                                        <p class="text-xs font-bold text-gray-500 mb-1">å—å½±éŸ¿å€‹æ¡ˆ:</p>
                                        <ul class="space-y-1">
                                            <li v-for="(c, idx) in leave.cases" :key="idx"
                                                class="text-xs text-gray-700 flex justify-between">
                                                <span>ğŸ‘¤ {{ c.name }}</span>
                                                <span class="text-gray-500">{{ c.time }}</span>
                                            </li>
                                        </ul>
                                    </div>

                                    <div v-if="leave.proofUrl">
                                        <a :href="leave.proofUrl" target="_blank"
                                            class="text-indigo-600 hover:underline text-xs flex items-center mt-2">
                                            ğŸ“ æŸ¥çœ‹è­‰æ˜æ–‡ä»¶
                                        </a>
                                    </div>
                                </div>
                                <div class="flex space-x-2 pt-2 border-t border-gray-100">
                                    <button @click="reviewLeave(leave, 'approve')"
                                        class="flex-1 bg-green-50 text-green-700 hover:bg-green-100 py-2 rounded-lg text-sm font-medium transition">
                                        æ ¸å‡†
                                    </button>
                                    <button @click="reviewLeave(leave, 'reject')"
                                        class="flex-1 bg-red-50 text-red-700 hover:bg-red-100 py-2 rounded-lg text-sm font-medium transition">
                                        é§å›
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: History -->
                        <div v-else class="space-y-3">
                            <div class="relative">
                                <input v-model="searchText" placeholder="æœå°‹å§“å..."
                                    class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <div class="max-h-96 overflow-y-auto space-y-2">
                                <div v-for="leave in filteredHistory" :key="leave.id"
                                    class="bg-gray-50 p-3 rounded-lg border border-gray-100 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium">{{ leave.name }}</span>
                                        <span :class="{
                                            'text-green-600': leave.status === 'Approved',
                                            'text-red-600': leave.status === 'Rejected',
                                            'text-yellow-600': leave.status === 'Pending',
                                            'text-gray-500': leave.status === 'Cancelled'
                                        }" class="text-xs font-bold">{{ leave.status === 'Approved' ? 'å·²æ ¸å‡†' :
                                            (leave.status === 'Rejected' ? 'å·²é§å›' : (leave.status === 'Cancelled' ? 'å·²å–æ¶ˆ'
                                            : 'å¾…å¯©æ ¸')) }}</span>
                                    </div>
                                    <div class="flex justify-between mt-1 text-gray-500 text-xs">
                                        <span>{{ leave.date }} ({{ leave.leaveType }})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Staff Leave Form View -->
                    <div v-else>
                        <div class="mb-4 flex items-center justify-between bg-indigo-50 p-3 rounded-lg">
                            <div>
                                <span class="text-indigo-900 font-medium block">ğŸ‘‹ ä½ å¥½ï¼Œ{{ user.name }}</span>
                                <div @click="showProfileSelector = true"
                                    class="flex items-center space-x-1 cursor-pointer mt-1">
                                    <span class="text-xs text-indigo-600 underline">
                                        {{ user.profiles && user.profiles.length > 1 ? 'åˆ‡æ›èº«ä»½ (' + user.profiles.length +
                                        ')' : '+ ç¶å®šæ–°å–®ä½' }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                <span
                                    class="text-xs bg-white text-indigo-600 border border-indigo-200 px-2 py-1 rounded-full">{{
                                    user.unit }}</span>
                                <span class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full">{{ user.role
                                    }}</span>
                            </div>
                        </div>

                        <!-- Tabs for Staff -->
                        <div class="flex space-x-2 mb-4 border-b border-gray-200 relative z-10">
                            <button type="button" @click="switchTab('apply')"
                                :class="activeTab === 'apply' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="flex-1 py-2 px-1 text-center border-b-2 font-medium text-sm cursor-pointer">
                                ç”³è«‹è«‹å‡
                            </button>
                            <button type="button" @click="switchTab('my_records')"
                                :class="activeTab === 'my_records' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="flex-1 py-2 px-1 text-center border-b-2 font-medium text-sm cursor-pointer">
                                æˆ‘çš„ç´€éŒ„
                            </button>
                        </div>

                        <!-- Tab: Apply -->
                        <form v-if="activeTab === 'apply'" @submit.prevent="submitLeave" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è«‹å‡æ—¥æœŸ</label>
                                <input type="date" v-model="leaveForm.date" required
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border">
                            </div>
                            <div class="flex space-x-6">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
                                    <input type="time" v-model="leaveForm.startTime" required
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“</label>
                                    <input type="time" v-model="leaveForm.endTime" required
                                        class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å‡åˆ¥</label>
                                <select v-model="leaveForm.leaveType" required
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border">
                                    <option value="ç—…å‡">ç—…å‡</option>
                                    <option value="äº‹å‡">äº‹å‡</option>
                                    <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
                                    <option value="å–ªå‡">å–ªå‡</option>
                                    <option value="å©šå‡">å©šå‡</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è«‹å‡äº‹ç”±</label>
                                <textarea v-model="leaveForm.reason" rows="2" required
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 px-3 border"
                                    placeholder="è«‹ç°¡è¿°åŸå› ..."></textarea>
                            </div>
                            <div v-if="['ç—…å‡', 'å–ªå‡', 'å©šå‡'].includes(leaveForm.leaveType)">
                                <label class="block text-sm font-medium text-gray-700 mb-1">è­‰æ˜æ–‡ä»¶ <span
                                        class="text-red-500">*</span></label>
                                <div
                                    class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-indigo-500 transition-colors cursor-pointer relative">
                                    <input type="file" @change="handleFileUpload" accept="image/*"
                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                    <div class="space-y-1 text-center">
                                        <span
                                            class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                            {{ leaveForm.proofPreview ? 'æ›´æ›åœ–ç‰‡' : 'ä¸Šå‚³åœ–ç‰‡' }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Case List -->
                            <div class="pt-4 border-t border-gray-200">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-sm font-medium text-gray-900">å—å½±éŸ¿å€‹æ¡ˆ</label>
                                    <button type="button" @click="addCase"
                                        class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition">+
                                        æ–°å¢å€‹æ¡ˆ</button>
                                </div>
                                <div v-if="leaveForm.cases.length === 0"
                                    class="text-center py-4 text-gray-400 text-sm bg-gray-50 rounded-lg border border-dashed border-gray-200">
                                    ç„¡å—å½±éŸ¿å€‹æ¡ˆ</div>
                                <div v-for="(item, index) in leaveForm.cases" :key="index"
                                    class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-2">
                                    <div class="relative mb-2">
                                        <input v-model="item.caseName" placeholder="å€‹æ¡ˆå§“å"
                                            class="text-sm w-full rounded border-gray-300 py-1.5 pl-2 pr-8 border">
                                        <button type="button" @click="removeCase(index)"
                                            class="absolute top-1/2 right-2 -translate-y-1/2 text-gray-400 hover:text-red-500 z-10 p-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="flex space-x-2">
                                        <input type="time" v-model="item.startTime"
                                            class="text-sm w-1/2 rounded border-gray-300 py-1.5 px-2 border">
                                        <span class="text-gray-400 self-center">~</span>
                                        <input type="time" v-model="item.endTime"
                                            class="text-sm w-1/2 rounded border-gray-300 py-1.5 px-2 border">
                                    </div>
                                </div>
                            </div>

                            <div class="pt-4">
                                <button type="submit" :disabled="submitting"
                                    class="w-full btn-primary text-white font-bold py-3 px-4 rounded-xl shadow-lg disabled:opacity-50">
                                    {{ submitting ? 'é€å‡ºä¸­...' : 'é€å‡ºç”³è«‹' }}
                                </button>
                            </div>
                        </form>

                        <!-- Tab: My Records -->
                        <div v-if="activeTab === 'my_records'" class="space-y-3">
                            <div v-if="!allLeaves || allLeaves.length === 0" class="text-center py-8 text-gray-400">
                                <p>å°šç„¡è«‹å‡ç´€éŒ„</p>
                            </div>
                            <div v-else class="space-y-3">
                                <div v-for="leave in allLeaves" :key="leave.id"
                                    class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h3 class="font-bold text-gray-900">{{ leave.leaveType }}</h3>
                                            <span class="text-xs text-gray-500">{{ leave.date }}</span>
                                        </div>
                                        <span :class="{
                                            'bg-green-100 text-green-800': leave.status === 'Approved',
                                            'bg-red-100 text-red-800': leave.status === 'Rejected',
                                            'bg-yellow-100 text-yellow-800': leave.status === 'Pending',
                                            'bg-gray-100 text-gray-800': leave.status === 'Cancelled'
                                        }" class="text-xs px-2 py-1 rounded-full font-medium">
                                            {{ leave.status === 'Approved' ? 'å·²æ ¸å‡†' : (leave.status === 'Rejected' ?
                                            'å·²é§å›' : (leave.status === 'Cancelled' ? 'å·²å–æ¶ˆ' : 'å¾…å¯©æ ¸')) }}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-2">{{ leave.reason }}</p>
                                    <div v-if="leave.status === 'Pending'" class="pt-2 border-t border-gray-100">
                                        <button @click="cancelLeave(leave)"
                                            class="w-full bg-red-50 text-red-600 hover:bg-red-100 py-2 rounded-lg text-sm font-medium transition">
                                            æ’¤å›ç”³è«‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
        <!-- Success Modal -->
        <div v-if="showModal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="relative p-5 border w-80 shadow-lg rounded-md bg-white text-center">
                <div class="mt-3">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">{{ modalMessage }}</h3>
                    <div class="mt-6 px-4 py-3">
                        <button @click="closeSuccessModal"
                            class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            ç¢ºå®š
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Selector Modal -->
        <div v-if="showProfileSelector"
            class="fixed inset-0 bg-gray-900/50 flex items-end sm:items-center justify-center z-[60]">
            <div class="bg-white w-full max-w-sm rounded-t-2xl sm:rounded-xl p-6 shadow-2xl transform transition-all">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">é¸æ“‡èº«ä»½</h3>
                    <button @click="showProfileSelector = false" class="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                <div class="space-y-3 max-h-80 overflow-y-auto">
                    <div v-for="(p, idx) in user.profiles" :key="idx" @click="switchProfile(p)"
                        :class="user.unit === p.unit ? 'border-2 border-indigo-500 bg-indigo-50' : 'border border-gray-200 hover:bg-gray-50'"
                        class="p-4 rounded-xl cursor-pointer transition-all relative">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-800">{{ p.unit }}</p>
                                <p class="text-sm text-gray-600">{{ p.name }} ({{ p.role }})</p>
                            </div>
                            <div v-if="user.unit === p.unit" class="text-indigo-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="user.registered = false; showProfileSelector = false"
                    class="w-full mt-4 py-3 text-indigo-600 font-medium text-sm hover:bg-indigo-50 rounded-lg">
                    + ç¶å®šæ–°æ©Ÿæ§‹
                </button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, reactive, computed } = Vue;
        const API_BASE = '';

        createApp({
            setup() {
                const loading = ref(true);
                const submitting = ref(false);
                const user = ref({ registered: false, name: '', role: '', uid: '', unit: '', profiles: [] });
                const showProfileSelector = ref(false);
                const units = ref([]);
                const debugInfo = ref(null);

                // View State
                const currentView = ref('landing'); // landing, menu, bulletin, leave, dev_apply

                // Supervisor State
                const activeTab = ref('pending');
                const allLeaves = ref([]);
                const searchText = ref('');

                const switchTab = (tab) => {
                    activeTab.value = tab;
                    if (tab === 'my_records' && (!allLeaves.value || allLeaves.value.length === 0)) {
                        fetchLeaves();
                    }
                };

                const regForm = reactive({ unit: '', name: '', staffId: '' });
                const leaveForm = reactive({
                    date: new Date().toISOString().split('T')[0],
                    startTime: '08:00',
                    endTime: '17:00',
                    leaveType: 'äº‹å‡',
                    reason: '',
                    proofBase66: null,
                    proofPreview: null,
                    cases: []
                });

                const initLiff = async () => {
                    try {
                        await liff.init({ liffId: "2008645610-0MezRE9Z" });
                        if (!liff.isLoggedIn()) { liff.login(); return; }
                        const profile = await liff.getProfile();
                        user.value.uid = profile.userId;
                        checkUserStatus(profile.userId);
                    } catch (err) {
                        alert('LIFF Init Failed: ' + err.message);
                        loading.value = false;
                    }
                };

                const checkUserStatus = async (uid) => {
                    try {
                        allLeaves.value = []; // Clear previous data
                        const res = await fetch(API_BASE + '/api/check-user', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uid })
                        });
                        const data = await res.json();

                        if (data.debug) {
                            debugInfo.value = data.debug;
                            console.log('Debug:', data.debug);
                        }

                        if (data.registered) {
                            user.value.registered = true;
                            user.value.profiles = data.profiles || [];
                            units.value = data.units || []; // Populate units for "Bind New"

                            // Auto-select first profile if none selected
                            if (!user.value.unit && user.value.profiles.length > 0) {
                                const first = user.value.profiles[0];
                                user.value.name = first.name;
                                user.value.role = first.role;
                                user.value.unit = first.unit;
                            }

                            // If multiple profiles, show selector? No, auto-select first is better UX, let them switch.

                            if (['Supervisor', 'ç£å°'].includes(user.value.role)) {
                                activeTab.value = 'pending';
                                fetchLeaves();
                            } else {
                                // Deep Linking Logic - Only if we are entering directly into the app
                                // But since we might be on 'landing' first, we need to decide when to process this.
                                // For now, let's keep the params logic but it might just set the tab in background.
                                const params = new URLSearchParams(window.location.search);
                                const targetTab = params.get('tab');
                                if (targetTab === 'my_records') {
                                    activeTab.value = 'my_records';
                                } else {
                                    activeTab.value = 'apply';
                                }
                                fetchLeaves();
                            }
                        } else {
                            user.value.registered = false;
                            units.value = data.units || [];
                            // If not registered, we probably should force them to the leave app to register? 
                            // Or keep them in menu? Let's keep flow simple: 
                            // User clicks "Start" -> "Leave App" -> prompts registration inside Leave App.
                        }
                    } catch (err) {
                        // alert('API Error: ' + err.message);
                        console.log('API Error masked for preview: ' + err.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const switchProfile = (profile) => {
                    user.value.name = profile.name;
                    user.value.role = profile.role;
                    user.value.unit = profile.unit;
                    showProfileSelector.value = false;

                    // Reset View based on role
                    if (['Supervisor', 'ç£å°'].includes(profile.role)) {
                        activeTab.value = 'pending';
                    } else {
                        activeTab.value = 'apply';
                    }

                    // Refetch Data for new context
                    allLeaves.value = [];
                    fetchLeaves();
                };

                const fetchLeaves = async () => {
                    try {
                        const res = await fetch(API_BASE + '/api/get-leaves', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uid: user.value.uid })
                        });
                        const data = await res.json();
                        if (data.success) {
                            allLeaves.value = data.leaves || [];
                            if (data.debug) console.log('Debug:', data.debug);
                        } else {
                            console.error('Fetch failed:', data.message);
                            // alert('ç„¡æ³•å–å¾—è³‡æ–™: ' + data.message);
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };

                const reviewLeave = async (leave, action) => {
                    const actionText = action === 'approve' ? 'æ ¸å‡†' : 'é§å›';
                    if (!confirm('ç¢ºå®šè¦' + actionText + ' ' + leave.name + ' çš„å‡å–®å—ï¼Ÿ')) return;

                    try {
                        const res = await fetch(API_BASE + '/api/review-leave', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: user.value.uid,
                                targetUid: leave.uid,
                                timestamp: leave.timestamp,
                                action: action,
                                name: leave.name
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('å·²æ›´æ–°ç‹€æ…‹');
                            fetchLeaves();
                        } else {
                            alert('æ“ä½œå¤±æ•—: ' + data.message);
                        }
                    } catch (e) { alert(e.message); }
                };

                const cancelLeave = async (leave) => {
                    if (!confirm('ç¢ºå®šè¦æ’¤å›é€™å¼µå‡å–®å—ï¼Ÿ')) return;
                    try {
                        const res = await fetch(API_BASE + '/api/cancel-leave', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: user.value.uid,
                                timestamp: leave.timestamp
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('å·²æ’¤å›');
                            fetchLeaves();
                        } else {
                            alert('æ“ä½œå¤±æ•—: ' + data.message);
                        }
                    } catch (e) { alert(e.message); }
                };

                const bindUser = async () => {
                    if (!regForm.unit || !regForm.name || !regForm.staffId) return alert('è«‹å¡«å¯«å®Œæ•´');
                    submitting.value = true;
                    try {
                        const res = await fetch(API_BASE + '/api/bind-user', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: user.value.uid,
                                unit: regForm.unit,
                                name: regForm.name,
                                staffId: regForm.staffId
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('ç¶å®šæˆåŠŸ');
                            window.location.reload();
                        } else {
                            alert(data.message || 'ç¶å®šå¤±æ•—');
                        }
                    } catch (e) { alert(e.message); }
                    submitting.value = false;
                };

                const showModal = ref(false);
                const modalMessage = ref('');

                const closeSuccessModal = () => {
                    showModal.value = false;
                    // liff.closeWindow(); // Do not close immediately, maybe return to menu?
                    if (currentView.value === 'leave') {
                        // stay here or go back?
                    }
                };
                const submitLeave = async () => {
                    if (['ç—…å‡', 'å–ªå‡', 'å©šå‡'].includes(leaveForm.leaveType) && !leaveForm.proofBase66) return alert('éœ€ä¸Šå‚³è­‰æ˜');

                    // Validate Global Time
                    if (!leaveForm.startTime || !leaveForm.endTime) return alert('è«‹å¡«å¯«å®Œæ•´æ™‚é–“');
                    const start = new Date(`2000-01-01T${leaveForm.startTime}`);
                    const end = new Date(`2000-01-01T${leaveForm.endTime}`);
                    const diff = (end - start) / (1000 * 60); // minutes

                    if (diff < 0) return alert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“');
                    if (diff < 60) return alert('è«‹å‡æ™‚é–“è‡³å°‘éœ€1å°æ™‚');

                    // Format Global Time
                    const globalTimeSlot = `${leaveForm.startTime} ~ ${leaveForm.endTime}`;
                    const duration = (diff / 60).toFixed(1); // Calculate Hours

                    submitting.value = true;
                    try {
                        const payload = { ...leaveForm, timeSlot: globalTimeSlot, duration: duration, uid: user.value.uid, name: user.value.name, unit: user.value.unit };
                        const res = await fetch(API_BASE + '/api/submit-leave', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (data.success) {
                            modalMessage.value = 'ç”³è«‹å·²é€å‡º';
                            showModal.value = true;
                            fetchLeaves(); // Refresh data
                        } else {
                            alert(data.error || 'å¤±æ•—');
                        }
                    } catch (e) { alert(e.message); }
                    submitting.value = false;
                };

                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        leaveForm.proofBase66 = e.target.result;
                        leaveForm.proofPreview = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };

                const addCase = () => leaveForm.cases.push({ caseName: '', startTime: '', endTime: '' });
                const removeCase = (i) => leaveForm.cases.splice(i, 1);

                // Computed
                const pendingLeaves = computed(() => {
                    return allLeaves.value.filter(l => l.status === 'Pending');
                });

                const filteredHistory = computed(() => {
                    let list = allLeaves.value;
                    if (searchText.value) {
                        list = list.filter(l => l.name.includes(searchText.value));
                    }
                    return list;
                });

                // Leaderboard Logic
                const maxDays = ref(1);
                const monthlyStats = computed(() => {
                    const now = new Date();
                    const currentMonth = now.toISOString().slice(0, 7);
                    const validLeaves = allLeaves.value.filter(l => l.status === 'Approved' && l.date.startsWith(currentMonth));
                    const userDays = {};
                    validLeaves.forEach(l => {
                        if (!userDays[l.name]) userDays[l.name] = new Set();
                        userDays[l.name].add(l.date);
                    });
                    const stats = Object.keys(userDays).map(name => ({ name: name, days: userDays[name].size }));
                    stats.sort((a, b) => b.days - a.days);
                    if (stats.length > 0) maxDays.value = Math.max(...stats.map(s => s.days));
                    return stats.slice(0, 5);
                });

                onMounted(() => initLiff());

                return {
                    currentView, // Export currentView
                    allLeaves,
                    loading, submitting, user, units, regForm, leaveForm, debugInfo,
                    activeTab, pendingLeaves, filteredHistory, searchText,
                    monthlyStats, maxDays, switchTab,
                    bindUser, submitLeave, handleFileUpload, addCase, removeCase, reviewLeave, cancelLeave,
                    showModal, modalMessage, closeSuccessModal,
                    showProfileSelector, switchProfile
                };
            }
        }).mount('#app');
    </script>
</body>

</html>